name: æ›´æ–°é¡¹ç›®å¾½ç« 

on:
  push:
    branches: [ main, master ]
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡æ›´æ–°å¾½ç« 
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-badges:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
      run: |
        pytest tests/ --cov=cocox --cov-report=xml

    - name: è·å–è¦†ç›–ç‡ç™¾åˆ†æ¯”
      id: coverage
      run: |
        COVERAGE=$(python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        coverage = float(root.attrib['line-rate']) * 100
        print(f'{coverage:.1f}')
        ")
        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºå¾½ç«  JSON
      run: |
        mkdir -p .github/badges
        
        # æµ‹è¯•çŠ¶æ€å¾½ç« 
        cat > .github/badges/tests.json << EOF
        {
          "schemaVersion": 1,
          "label": "tests",
          "message": "passing",
          "color": "success"
        }
        EOF
        
        # è¦†ç›–ç‡å¾½ç« 
        COVERAGE_COLOR="red"
        if (( $(echo "${{ steps.coverage.outputs.percentage }} >= 80" | bc -l) )); then
          COVERAGE_COLOR="green"
        elif (( $(echo "${{ steps.coverage.outputs.percentage }} >= 60" | bc -l) )); then
          COVERAGE_COLOR="yellow"
        fi
        
        cat > .github/badges/coverage.json << EOF
        {
          "schemaVersion": 1,
          "label": "coverage",
          "message": "${{ steps.coverage.outputs.percentage }}%",
          "color": "$COVERAGE_COLOR"
        }
        EOF
        
        # Python ç‰ˆæœ¬å¾½ç« 
        cat > .github/badges/python.json << EOF
        {
          "schemaVersion": 1,
          "label": "python",
          "message": "3.8+ | 3.12",
          "color": "blue"
        }
        EOF
        
        # è®¸å¯è¯å¾½ç« 
        cat > .github/badges/license.json << EOF
        {
          "schemaVersion": 1,
          "label": "license",
          "message": "MIT",
          "color": "blue"
        }
        EOF

    - name: æäº¤å¾½ç« æ–‡ä»¶
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .github/badges/
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰å¾½ç« éœ€è¦æ›´æ–°"
        else
          git commit -m "ğŸ·ï¸ æ›´æ–°é¡¹ç›®å¾½ç«  [skip ci]"
          git push
        fi 
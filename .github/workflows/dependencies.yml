name: ä¾èµ–ç®¡ç†å’Œå®‰å…¨æ£€æŸ¥

on:
  schedule:
    # æ¯å‘¨ä¸€è¿è¡Œä¾èµ–æ£€æŸ¥
    - cron: '0 8 * * 1'
  push:
    branches: [ main, master ]
    paths:
      - 'pyproject.toml'
      - 'requirements*.txt'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¾èµ–å®¡æŸ¥
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate

  # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
  outdated-dependencies:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: å®‰è£…å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit pipx
        pipx install pip-check-updates

    - name: æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
      run: |
        pip install -e .
        pip list --outdated

    - name: å®‰å…¨å®¡è®¡
      run: |
        pip-audit --desc --format=json --output=audit-report.json
        pip-audit --desc

    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-report
        path: audit-report.json

  # ä¾èµ–è®¸å¯è¯æ£€æŸ¥
  license-check:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: å®‰è£…ä¾èµ–å’Œå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pip-licenses

    - name: æ£€æŸ¥ä¾èµ–è®¸å¯è¯
      run: |
        pip-licenses --format=json --output-file=licenses.json
        pip-licenses --format=markdown --output-file=licenses.md
        pip-licenses

    - name: ä¸Šä¼ è®¸å¯è¯æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: license-report
        path: |
          licenses.json
          licenses.md

  # åˆ›å»º issue æŠ¥å‘Šè¿‡æ—¶ä¾èµ–
  create-dependency-issue:
    runs-on: ubuntu-latest
    needs: [outdated-dependencies]
    if: github.event_name == 'schedule'
    permissions:
      issues: write
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆ›å»ºä¾èµ–æ›´æ–° Issue
      uses: actions/github-script@v6
      with:
        script: |
          const title = 'ğŸ”„ å®šæœŸä¾èµ–æ›´æ–°æ£€æŸ¥';
          const body = `
          ## ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š
          
          è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Šã€‚
          
          ### æ‰§è¡Œæ—¶é—´
          ${new Date().toLocaleString('zh-CN')}
          
          ### æ£€æŸ¥å†…å®¹
          - âœ… å®‰å…¨æ¼æ´æ‰«æ
          - âœ… è¿‡æ—¶ä¾èµ–æ£€æŸ¥
          - âœ… è®¸å¯è¯å…¼å®¹æ€§æ£€æŸ¥
          
          ### å»ºè®®æ“ä½œ
          1. æŸ¥çœ‹ Actions è¿è¡Œç»“æœä¸­çš„è¯¦ç»†æŠ¥å‘Š
          2. æ›´æ–°æœ‰å®‰å…¨æ¼æ´çš„ä¾èµ–
          3. è€ƒè™‘æ›´æ–°ä¸»è¦ç‰ˆæœ¬è¿‡æ—¶çš„ä¾èµ–
          
          ### ç›¸å…³é“¾æ¥
          - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
          - [ä¾èµ–æ–‡ä»¶](${context.payload.repository.html_url}/blob/main/pyproject.toml)
          
          ---
          *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          `;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„ issue
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['dependencies', 'automated']
          });
          
          if (existingIssues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'automated', 'maintenance']
            });
          } 